<!DOCTYPE html>
<html>

<head>

    <meta http-equiv="Expires" content="86400">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta charset="utf-8">
    <meta name="typewriter" content="An interactive exhibit for the Jack London Museum">

    <!--    <meta http-equiv="X-UA-Compatible" content="IE=edge">-->
    <title>Tell Your Story</title>
    <link rel="stylesheet" href="main.css">
    <script type='text/javascript' src='js/StarWebPrintBuilder.js'></script>
    <script type='text/javascript' src='js/StarWebPrintTrader.js'></script>
    <script type="text/javascript">
        function print() {

            var textArea = String(document.getElementById('targetTextArea').value.replace(/\n/gi, '<br>'));

            var cleanTextArea = textArea.replace(/<br>/g, "\n");
            
            var wrapped = wordwrap(cleanTextArea,24);

            console.log(wrapped);


            var builder = new StarWebPrintBuilder();

            var request = '';

            request += builder.createInitializationElement();

            request += builder.createTextElement({
                characterspace: 0,
                width: 2,
                height: 2
            });

            request += builder.createAlignmentElement({
                position: 'left'
            });
            var newLine = "\n"
            request += builder.createTextElement({
                data: newLine.repeat(7)
            });
            request += builder.createTextElement({
                data: cleanTextArea
            });
            request += builder.createCutPaperElement({
                feed: true
            });

            var url = "https://localhost:8001/StarWebPRNT/SendMessage";
            var papertype = "normal";
            var trader = new StarWebPrintTrader({
                url: url,
                papertype: papertype
            });

            //            trader.onReceive = function(response) {
            //                alert(response.responseText);
            //            }
                        trader.onError = function(response) {
                            alert(response.responseText);
                        }
            console.log(request);
            trader.sendMessage({
                request: request
            });
            document.getElementById("targetTextArea").value = "";

            //            setTimeout(location.reload(), 4000);


        }

        var wordwrap = function(long_string, max_char) {
                if (long_string == null) {
                    return " ";
                } else {

                    var sum_length_of_words = function(word_array) {
                        var out = 0;
                        if (word_array.length != 0) {
                            for (var i = 0; i < word_array.length; i++) {
                                var word = word_array[i];
                                out = out + word.length;
                            }
                        };
                        return out;
                    };


                    var chunkString = function(str, length) {
                        return str.match(new RegExp('.{1,' + length + '}', 'g'));
                    };

                    var splitLongWord = function(word, maxChar) {
                        var out = [];
                        if (maxChar >= 1) {
                            var wordArray = chunkString(word, maxChar - 1); // just one under maxChar in order to add the innerword separator '-'
                            if (wordArray.length >= 1) {
                                // Add every piece of word but the last, concatenated with '-' at the end
                                for (var i = 0; i < (wordArray.length - 1); i++) {
                                    var piece = wordArray[i] + "-";
                                    out.push(piece);
                                }
                                // finally, add the last piece
                                out.push(wordArray[wordArray.length - 1]);
                            }
                        }
                        // If nothing done, just use the same word
                        if (out.length == 0) {
                            out.push(word);
                        }
                        return out;
                    }

                    var split_out = [
                        []
                    ];
                    var split_string = long_string.split(' ');
                    for (var i = 0; i < split_string.length; i++) {
                        var word = split_string[i];

                        // If the word itself exceed the max length, split it,
                        if (word.length > max_char) {
                            var wordPieces = splitLongWord(word, max_char);
                            for (var j = 0; j < wordPieces.length; j++) {
                                var wordPiece = wordPieces[j];
                                split_out = split_out.concat([
                                    []
                                ]);
                                split_out[split_out.length - 1] = split_out[split_out.length - 1].concat(wordPiece);
                            }

                        } else {
                            // otherwise add it if possible
                            if ((sum_length_of_words(split_out[split_out.length - 1]) + word.length + 1) > max_char) {
                                split_out = split_out.concat([
                                    []
                                ]);
                            }

                            split_out[split_out.length - 1] = split_out[split_out.length - 1].concat(word);
                        }
                    }

                    for (var i = 0; i < split_out.length; i++) {
                        split_out[i] = split_out[i].join(" ");
                    }

                    return split_out.join('\n');
                }};
    </script>

</head>

<body>

    <h1 align="center">What's Your Story?</h1>

    <div class="myelement1">

        <textarea maxlength="1200" type="text" name="textarea" wrap="wrap" id="targetTextArea" rows="10" cols="30" placeholder="Tell Your Story..."></textarea>
        <input type="submit" onclick="print()" value="Print Text" />

    </div>

</body>