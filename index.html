<!DOCTYPE html>
<html>

<head>

    <meta http-equiv="Expires" content="86400">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta charset="utf-8">
    <meta name="typewriter" content="An interactive exhibit for the Jack London Museum">

    <!--    <meta http-equiv="X-UA-Compatible" content="IE=edge">-->
    <title>Tell Your Story</title>
    <link rel="stylesheet" href="main.css">
    <script type='text/javascript' src='js/StarWebPrintBuilder.js'></script>
    <script type='text/javascript' src='js/StarWebPrintTrader.js'></script>
    <script src="js/jquery-3.3.1.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            $('textarea[data-limit-rows=true]')
                .on('keypress', function(event) {
                    var textarea = $(this),
                        text = textarea.val(),
                        numberOfLines = (text.match(/\n/g) || []).length + 1,
                        maxRows = parseInt(textarea.attr('rows'));

                    if (event.which === 13 && numberOfLines === maxRows) {
                        return false;
                    }
                });
            $('#targetTextArea').bind("cut copy paste", function(e) {
                e.preventDefault();
            });
        });






        function print() {

            var textArea = String(document.getElementById('targetTextArea').value.replace(/\n/gi, '<br>'));

            var cleanTextArea = textArea.replace(/<br>/g, "\n");

            var wrapped = wordWrap(cleanTextArea, 24);


            console.log(wrapped);


            var builder = new StarWebPrintBuilder();

            var request = '';

            request += builder.createInitializationElement();

            request += builder.createTextElement({
                characterspace: 0,
                width: 2,
                height: 2
            });

            request += builder.createAlignmentElement({
                position: 'left'
            });
            var newLine = "\n"
            request += builder.createTextElement({
                data: newLine.repeat(7)
            });
            request += builder.createTextElement({
                data: wrapped
            });
            request += builder.createCutPaperElement({
                feed: true
            });

            var url = "https://localhost:8001/StarWebPRNT/SendMessage";
            var papertype = "normal";
            var trader = new StarWebPrintTrader({
                url: url,
                papertype: papertype
            });

            //            trader.onReceive = function(response) {
            //                alert(response.responseText);
            //            }
            trader.onError = function(response) {
                alert(response.responseText);
            }
            console.log(request);
            trader.sendMessage({
                request: request
            });
            document.getElementById("targetTextArea").value = "";

            //            setTimeout(location.reload(), 4000);


        }

        //        str = wordWrap(str, 40);

        function wordWrap(str, maxWidth) {
            var newLineStr = "\n";
            done = false;
            res = '';
            do {
                found = false;
                // Inserts new line at first whitespace of the line
                for (i = maxWidth - 1; i >= 0; i--) {
                    if (testWhite(str.charAt(i))) {
                        res = res + [str.slice(0, i), newLineStr].join('');
                        str = str.slice(i + 1);
                        found = true;
                        break;
                    }
                }
                // Inserts new line at maxWidth position, the word is too long to wrap
                if (!found) {
                    res += [str.slice(0, maxWidth), newLineStr].join('');
                    str = str.slice(maxWidth);
                }

                if (str.length < maxWidth)
                    done = true;
            } while (!done);

            return res + str;
        }

        function testWhite(x) {
            var white = new RegExp(/^\s$/);
            return white.test(x.charAt(0));
        };

    </script>

</head>

<body>

    <h1 align="center">What's Your Story?</h1>

    <div class="myelement1">

        <textarea data-limit-rows="true" cols="24" rows="28" type="text" name="textarea" wrap="wrap" id="targetTextArea" rows="10" cols="30" placeholder="Tell Your Story..."></textarea>
        <input type="submit" onclick="print()" value="Print Text" />
        <!--maxlength="672"-->
    </div>

</body>
